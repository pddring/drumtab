<!DOCTYPE html>
<html>
    <head>
        <title>DrumTab</title>
        <link rel="stylesheet" href="styles.css">
    <body>
    <div id="main">       
        <div class="controls">
            <button id="btn-slower">-</button>
            <input id="bpm" value="60">
            <button id="btn-faster">+</button>
            <button id="btn-play-stop">Play</button>
            <select id="repeat">
                <option value="1">No repeat</option>
                <option value="2">x2</option>
                <option value="4">x4</option>
                <option value="8">x8</option>
                <option value="16" selected>x16</option>
                <option value="32">x32</option>
                <option value="64">x64</option>
            </select>

            <label class="switch">
                <input id="speedup" type="checkbox">Speed up
            </label>

            <select id="voicing">
                <option value="0">Single voice</option>
                <option value="1" selected>Hands and feet</option>
                <option value="2">Cymbals and drums</option>
            </select>
            <button id="btn-save">Save</button>
        </div>
        <h2>Score<button class="toggle" data-toggle="score">+/-</button></h2>
        <div id="score"></div>
        <h2>Drums<button class="toggle" data-toggle="drums">+/-</button></h2>
        <canvas id="drums" width="600" height="600">
        </canvas>
    </div>

    <h2>Tab<button class="toggle" data-toggle="tab">+/-</button></h2>
        <p>Type out or copy your drum tab here</p>
<textarea id="tab">
</textarea>

    <h2>ABC<button class="toggle" data-toggle="abc">+/-</button></h2>
    <p>This should be auto generated from the drum tab (included for debugging here)</p>
<textarea id="abc">

</textarea>

    <h2>Settings<button class="toggle" data-toggle="settings">+/-</button></h2>
    <div id="settings">
        <label class="switch">
            <input id="audio" type="checkbox">Play sounds (Audio)
        </label>
        <label class="switch">
            <input id="midi" type="checkbox">Play sounds (Midi)
        </label>
    </div>
<script
src="https://code.jquery.com/jquery-3.6.3.min.js"
integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="lib/abcjs-basic-min.js"></script> 
    <script src="lib/lz-string.min.js"></script>
    <script src="media/jdd200/kit.js"></script>
    <script src="drumtab.js"></script> 
    <script>
        drumtab.init("drums");
        const eTab = document.getElementById("tab");
        const eAbc = document.getElementById("abc");
        const eScore = document.getElementById("score");
        const eVoicing = document.getElementById("voicing");
        const ePlayStop = document.getElementById("btn-play-stop");
        const eBPM = document.getElementById("bpm");
        const eRepeat = document.getElementById("repeat");
        const eSave = document.getElementById("btn-save");
        const eSpeedup = document.getElementById("speedup");
        const ePlayAudio = document.getElementById("audio");
        const ePlayMidi = document.getElementById("midi");

        document.querySelectorAll(".toggle").forEach((toggle) => {
            const id = toggle.dataset.toggle;
            toggle.addEventListener("click", (e) => {
                const eToggle = document.getElementById(id);
                const visible = eToggle.style.display != "none";
                eToggle.style.display = visible?"none":"initial";
            });
            
        });

        // load settings
        drumtab.load();
        eTab.value = drumtab.options.tab;
        eRepeat.value = drumtab.options.repeat;
        eBPM.value = drumtab.options.bpm;
        eVoicing.value = drumtab.options.voicing;
        eSpeedup.checked = drumtab.options.speedup;
        ePlayAudio.checked = drumtab.options.audio;

        eSave.addEventListener("click", drumtab.save);

        eSpeedup.addEventListener("change", (e) => {
            drumtab.options.speedup = e.currentTarget.checked;
        });

        ePlayAudio.addEventListener("change", (e) => {
            drumtab.options.audio = e.currentTarget.checked;
        });
        ePlayMidi.addEventListener("change", (e) => {
            drumtab.options.midi = e.currentTarget.checked;
        });

        eBPM.addEventListener("change", e => {
            bpm = parseInt(eBPM.value);
            updateBPM();
        });
        document.getElementById("btn-faster").addEventListener("click", e => {
            drumtab.options.bpm += 5;
            updateBPM();
        });

        document.getElementById("btn-slower").addEventListener("click", e => {
            drumtab.options.bpm -= 5;
            updateBPM();
        });

        let playing = false;
        
        function updateBPM() {
            eBPM.value = drumtab.options.bpm;
            drumtab.setBPM(drumtab.options.bpm);
        }
        
        ePlayStop.addEventListener("click", e=> {
            if(drumtab.playing && !drumtab.playback.isPaused) {
                drumtab.pause();
                ePlayStop.innerText = "Resume";
            } else {
                ePlayStop.innerText = "Stop";
                let repeatCount = parseInt(eRepeat.value);
                drumtab.play(repeatCount, e => {
                    ePlayStop.innerText = "Play";
                });
            }
        });

        eTab.addEventListener("input", updateABC);
        eAbc.addEventListener("input", updateScore);
        eRepeat.addEventListener("change", (e) => {
            drumtab.options.repeat = e.currentTarget.value;
        });
        eVoicing.addEventListener("change", (e => {
            drumtab.options.voicing = e.currentTarget.value;
            updateABC();
        }));

        function updateABC() {
            let tab = eTab.value;
            eAbc.value = drumtab.Tab2ABC(tab, drumtab.options.voicing);
            updateScore();
        }
        var selectedNotes = [];
        function updateScore() {
            let abc = eAbc.value;
            score = ABCJS.renderAbc("score", abc, {
                add_classes: true,
                clickListener: (element, tuneNumber, classes, analysis, drag, mouseevent) => {
                    let bar = analysis.measure;
                    for(let i = 0; i < analysis.line; i++) {
                        bar += drumtab.drums.lines[i];
                    }
                    let beat = bar * drumtab.drums.beats;
                    let m = classes.match(/abcjs-v(\d+) abcjs-n(\d+)/);
                    if(m) {
                        let n = {
                            bar: bar,
                            voiceId: parseInt(m[1]),
                            noteId: parseInt(m[2])
                        }
                        n.notes = drumtab.drums.bars[n.bar].voicing[drumtab.drums.voices[n.voiceId]].beats;
                        let noteCount = 0;
                        for(let i = 0; i < drumtab.drums.beats; i++) {
                            if(n.notes[i]) {
                                noteCount++;
                                if(noteCount > n.noteId) {
                                    n.beat = i;
                                    break;
                                }
                            }
                        }
                        beat += n.beat;
                    }
                    if(drumtab.playback) {
                        drumtab.playback.setProgress(beat, "beats");
                    }
                }
            })[0];

        }

        updateABC();
        updateScore();


    </script>
    </body>
</html>
